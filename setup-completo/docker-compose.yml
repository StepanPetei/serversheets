version: '3.9'

services:
  wordpress:
      image: wordpress:latest
          container_name: wordpress
              restart: always
                  environment:
                        WORDPRESS_DB_HOST: mysql:3306
                              WORDPRESS_DB_NAME: wordpress
                                    WORDPRESS_DB_USER: wpuser
                                          WORDPRESS_DB_PASSWORD: wppassword
                                              networks:
                                                    - internal
                                                        volumes:
                                                              - wordpress_data:/var/www/html

                                                                mysql:
                                                                    image: mysql:8.0
                                                                        container_name: mysql
                                                                            restart: always
                                                                                environment:
                                                                                      MYSQL_ROOT_PASSWORD: rootpassword
                                                                                            MYSQL_DATABASE: wordpress
                                                                                                  MYSQL_USER: wpuser
                                                                                                        MYSQL_PASSWORD: wppassword
                                                                                                            command: --default-authentication-plugin=mysql_native_password
                                                                                                                networks:
                                                                                                                      - internal
                                                                                                                          volumes:
                                                                                                                                - mysql_data:/var/lib/mysql

                                                                                                                                  phpmyadmin:
                                                                                                                                      image: phpmyadmin/phpmyadmin
                                                                                                                                          container_name: phpmyadmin
                                                                                                                                              restart: always
                                                                                                                                                  depends_on:
                                                                                                                                                        - mysql
                                                                                                                                                            environment:
                                                                                                                                                                  PMA_HOST: mysql
                                                                                                                                                                        PMA_USER: root
                                                                                                                                                                              PMA_PASSWORD: rootpassword
                                                                                                                                                                                  networks:
                                                                                                                                                                                        - internal

                                                                                                                                                                                          odoo:
                                                                                                                                                                                              image: odoo:17
                                                                                                                                                                                                  container_name: odoo
                                                                                                                                                                                                      restart: always
                                                                                                                                                                                                          environment:
                                                                                                                                                                                                                - HOST=postgres
                                                                                                                                                                                                                      - USER=odoo
                                                                                                                                                                                                                            - PASSWORD=odoopassword
                                                                                                                                                                                                                                depends_on:
                                                                                                                                                                                                                                      - postgres
                                                                                                                                                                                                                                          networks:
                                                                                                                                                                                                                                                - internal
                                                                                                                                                                                                                                                    ports:
                                                                                                                                                                                                                                                          - "8069:8069"
                                                                                                                                                                                                                                                              volumes:
                                                                                                                                                                                                                                                                    - odoo_data:/var/lib/odoo

                                                                                                                                                                                                                                                                      postgres:
                                                                                                                                                                                                                                                                          image: postgres:15
                                                                                                                                                                                                                                                                              container_name: postgres
                                                                                                                                                                                                                                                                                  restart: always
                                                                                                                                                                                                                                                                                      environment:
                                                                                                                                                                                                                                                                                            POSTGRES_DB=postgres
                                                                                                                                                                                                                                                                                                  POSTGRES_USER=odoo
                                                                                                                                                                                                                                                                                                        POSTGRES_PASSWORD=odoopassword
                                                                                                                                                                                                                                                                                                            networks:
                                                                                                                                                                                                                                                                                                                  - internal
                                                                                                                                                                                                                                                                                                                      volumes:
                                                                                                                                                                                                                                                                                                                            - postgres_data:/var/lib/postgresql/data

                                                                                                                                                                                                                                                                                                                              portainer:
                                                                                                                                                                                                                                                                                                                                  image: portainer/portainer-ce:latest
                                                                                                                                                                                                                                                                                                                                      container_name: portainer
                                                                                                                                                                                                                                                                                                                                          restart: always
                                                                                                                                                                                                                                                                                                                                              command: -H unix:///var/run/docker.sock
                                                                                                                                                                                                                                                                                                                                                  volumes:
                                                                                                                                                                                                                                                                                                                                                        - /var/run/docker.sock:/var/run/docker.sock
                                                                                                                                                                                                                                                                                                                                                              - portainer_data:/data
                                                                                                                                                                                                                                                                                                                                                                  networks:
                                                                                                                                                                                                                                                                                                                                                                        - internal

                                                                                                                                                                                                                                                                                                                                                                          nginx:
                                                                                                                                                                                                                                                                                                                                                                              image: nginx:latest
                                                                                                                                                                                                                                                                                                                                                                                  container_name: nginx
                                                                                                                                                                                                                                                                                                                                                                                      restart: always
                                                                                                                                                                                                                                                                                                                                                                                          ports:
                                                                                                                                                                                                                                                                                                                                                                                                - "80:80"
                                                                                                                                                                                                                                                                                                                                                                                                      - "443:443"
                                                                                                                                                                                                                                                                                                                                                                                                          volumes:
                                                                                                                                                                                                                                                                                                                                                                                                                - ./nginx/conf.d:/etc/nginx/conf.d
                                                                                                                                                                                                                                                                                                                                                                                                                      - certbot-etc:/etc/letsencrypt
                                                                                                                                                                                                                                                                                                                                                                                                                            - certbot-var:/var/lib/letsencrypt
                                                                                                                                                                                                                                                                                                                                                                                                                                  - ./nginx/html:/usr/share/nginx/html
                                                                                                                                                                                                                                                                                                                                                                                                                                      depends_on:
                                                                                                                                                                                                                                                                                                                                                                                                                                            - wordpress
                                                                                                                                                                                                                                                                                                                                                                                                                                                  - phpmyadmin
                                                                                                                                                                                                                                                                                                                                                                                                                                                        - odoo
                                                                                                                                                                                                                                                                                                                                                                                                                                                              - portainer
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  networks:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - internal
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              - external

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                certbot:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    image: certbot/certbot
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        container_name: certbot
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            volumes:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  - certbot-etc:/etc/letsencrypt
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - certbot-var:/var/lib/letsencrypt
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              - ./nginx/html:/usr/share/nginx/html
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  entrypoint: "/bin/sh -c 'trap exit TERM; while :; do sleep 6h & wait $${!}; certbot renew; done'"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      networks:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - external

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            volumes:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              wordpress_data:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                mysql_data:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  postgres_data:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    odoo_data:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      portainer_data:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        certbot-etc:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          certbot-var:

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          networks:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            internal:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              external: